version: "3.4"

services:
  fooapp:
    build:
      context: ./fooapp
    networks:
      - dummynetwork

  barapp:
    build:
      context: ./barapp
    networks:
      - dummynetwork

  api:
    build:
      context: ./api
    networks:
      - dummynetwork

  gateway:
    build:
      context: ./gateway
    ports:
      - 80:80
      - 443:443
    environment:
      - FOOAPP_URL=${FOOAPP_URL}
      - BARAPP_URL=${BARAPP_URL}
      - API_URL=${API_URL}
    command: /bin/bash -c "envsubst '$${FOOAPP_URL},$${BARAPP_URL},$${API_URL}' < /etc/nginx/nginx.template > /etc/nginx/nginx.conf && exec nginx -g 'daemon off;'"
    networks:
      - dummynetwork
    depends_on:
      - fooapp
      - barapp
      - api

networks:
  dummynetwork:
